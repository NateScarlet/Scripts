# Deploy-CurrentCommit.ps1
#Requires -Version 7.0
$ErrorActionPreference = "Stop"

# ç›®æ ‡è„šæœ¬è·¯å¾„ï¼ˆæœ¬åœ°åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•ï¼‰
$targetDir = Join-Path $env:LOCALAPPDATA "Scripts"

# æ£€æŸ¥æœªæäº¤æ–‡ä»¶
$uncommitted = git status --porcelain | Where-Object { $_ -notmatch "^.. Deploy-CurrentCommit\.ps1$" } # å¿½ç•¥è‡ªèº«æ–¹ä¾¿æµ‹è¯•
if ($uncommitted) {
    Write-Host "âŒ å­˜åœ¨æœªæäº¤çš„ä¿®æ”¹ï¼Œè¯·å…ˆæäº¤æˆ–æš‚å­˜åå†éƒ¨ç½²ï¼š" -ForegroundColor Red
    Write-Host $uncommitted
    exit 1
}

$currentHead = git rev-parse HEAD
$shortHead = $currentHead.Substring(0, 7)

#region å·¥ä½œæ ‘

# å¦‚æœç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶åˆå§‹åŒ–å·¥ä½œæ ‘
if (-not (Test-Path $targetDir -PathType Container)) {
    # ä½¿ç”¨ git worktree åˆ›å»ºæ–°å·¥ä½œæ ‘
    git worktree add --detach $targetDir $currentHead
    if ($LASTEXITCODE -ne 0) {
        Write-Host "âŒ åˆ›å»ºå·¥ä½œæ ‘å¤±è´¥" -ForegroundColor Red
        exit 1
    }
    Write-Host "ğŸŒ± åˆ›å»ºæ–°å·¥ä½œæ ‘: $targetDir"
}
else {
    # ç›´æ¥æ›´æ–°ç°æœ‰å·¥ä½œæ ‘åˆ°å½“å‰HEAD
    $previousHead = git -C $targetDir rev-parse HEAD
    if ($previousHead -eq $currentHead) {
        Write-Host "â© å·¥ä½œæ ‘å·²ç»ä½äº $shortHeadï¼Œæ— éœ€æ›´æ–°"
    }
    else {
        git -C $targetDir checkout --detach $currentHead
        if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ ç›®æ ‡ç›®å½•æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸ŠGité”™è¯¯ä¿¡æ¯" -ForegroundColor Red
            exit 2
        }
        Write-Host "ğŸ”„ æ›´æ–°å·¥ä½œæ ‘åˆ°å½“å‰HEAD ($($previousHead.Substring(0,7)) -> $shortHead)"
    }
}
#endregion

#region é…ç½® PowerShell Profile
$profileScriptPath = Join-Path $targetDir "profiles\Microsoft.PowerShell_profile.ps1"
if (Test-Path $profileScriptPath) {
    $markerStart = "#region ğŸš€ Auto-Generated by Deploy-CurrentCommit.ps1 (64094a1431f6), DO NOT EDIT."
    $markerEnd = "#endregion ğŸš€"
    $profileBlock = @"
$markerStart
`$ScriptsRoot = "$targetDir"
. "`$ScriptsRoot\profiles\Microsoft.PowerShell_profile.ps1"
$markerEnd
"@ 
    
    # è¯»å–å½“å‰ profile å†…å®¹
    $profileContent = if (Test-Path $PROFILE) { 
        (Get-Content $PROFILE -Raw) -replace "`r`n", "`n" # å¿½ç•¥æ¢è¡Œç¬¦å·®å¼‚
    }
    else { 
        "" 
    }
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ ‡è®°å—
    if ($profileContent -match [regex]::Escape($markerStart)) {
        # æ›´æ–°ç°æœ‰å—
        $pattern = "(?s)" + [regex]::Escape($markerStart) + ".*?" + [regex]::Escape($markerEnd)
        $updatedContent = $profileContent -replace $pattern, $profileBlock
        if ($updatedContent -ne $profileContent) {
            $updatedContent | Set-Content $PROFILE
            Write-Host "âœ… æ›´æ–° PowerShell Profile å¼•ç”¨"
        }
        else {
            Write-Host "â© PowerShell Profile å¼•ç”¨å·²æ˜¯æœ€æ–°"
        }
    }
    else {
        # æ·»åŠ æ–°å—åˆ°æ–‡ä»¶æœ«å°¾
        $newContent = if ($profileContent.Trim().Length -gt 0) {
            $profileContent.Trim() + "`n`n" + $profileBlock
        }
        else {
            $profileBlock
        }
        $newContent | Set-Content -NoNewline $PROFILE
        Write-Host "âœ… æ·»åŠ  PowerShell Profile å¼•ç”¨"
    }
}
else {
    Write-Host "âš ï¸  æœªæ‰¾åˆ° $profileScriptPathï¼Œè·³è¿‡ Profile é…ç½®" -ForegroundColor Yellow
}
# endregion

#region è®¡åˆ’ä»»åŠ¡ç®¡ç†
$taskName = "æ¯æ—¥è¿è¡Œè‡ªå®šä¹‰è„šæœ¬_015aa3e1"
$targetScript = Join-Path $targetDir "automation\Invoke-DailyTask.ps1"
$currentDescription = "æ¯æ—¥æ‰§è¡Œç»´æŠ¤è„šæœ¬ (Commit: $shortHead)"
# æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
if (Test-Path $targetScript) {
    # åˆ›å»ºæ–°çš„ä»»åŠ¡åŠ¨ä½œ
    $newAction = New-ScheduledTaskAction -Execute "$PSHOME\pwsh.exe" `
        -Argument "-File `"$targetScript`""
    
    $task = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
    
    if (-not $task) {
        # åˆ›å»ºæ–°ä»»åŠ¡
        $trigger = New-ScheduledTaskTrigger -Daily -At 04:00
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
        $principal = New-ScheduledTaskPrincipal -UserId "$env:USERDOMAIN\$env:USERNAME" -LogonType Interactive
        
        Register-ScheduledTask `
            -TaskName $taskName `
            -Action $newAction `
            -Trigger $trigger `
            -Settings $settings `
            -Principal $principal `
            -Description $currentDescription
        
        Write-Host "âœ… è®¡åˆ’ä»»åŠ¡å·²åˆ›å»º: $taskName"
    }
    elseif ($task.Description -ne $currentDescription) {
        # æ›´æ–°åŠ¨ä½œå’Œæè¿°
        $task.Actions = $newAction
        $task.Description = $currentDescription
        # ä¸æ›´æ–°è§¦å‘å™¨ï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰

        # ä¿å­˜æ›´æ–°
        $null = Set-ScheduledTask $task
            
        Write-Host "ğŸ”„ æ›´æ–°è®¡åˆ’ä»»åŠ¡: $taskName"
    }
    else {
        Write-Host "â© è®¡åˆ’ä»»åŠ¡ $taskName å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    }   
}
else {
    Write-Host "âš ï¸  æœªæ‰¾åˆ° $targetScriptï¼Œè·³è¿‡è®¡åˆ’ä»»åŠ¡ç®¡ç†" -ForegroundColor Yellow
}

#endregion

Write-Host "ğŸ‰ éƒ¨ç½²å®Œæˆï¼è„šæœ¬å·²æ›´æ–°åˆ°ç‰ˆæœ¬ $shortHeadã€‚" -ForegroundColor Green
